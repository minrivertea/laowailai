{% extends "base.html" %}
{% load thumbnail %}
{% load comments %}

{% block metadescription %}The best place to share news and events for foreigners in {{ current_city }}, China.{% endblock %}
{% block pagetitle %}News from {{ city }}{% endblock %}

{% block extrajs %}
<script type="text/javascript" charset="utf-8">  

function bindPostCommentHandler(idx) {   
	var thisObject = $('#comment-form-' + idx + ' form'); 
    thisObject.submit(function() {
    	if ($('#comment-form-' + idx + ' form textarea').val() == '') {
    		this.Object.prepend('<p class="warning" style="color:red; display:block;"><em>You must type something</em></p>');
    	}
    	else {
        	$.ajax({  
        	    type: "POST",  
        	    data: $('#comment-form-' + idx + ' form').serialize(),  
        	    url: "/comments/post/",  
        	    cache: false,  
        	    dataType: "html",  
        	    success: function(data, textStatus) {
        	        $('#comments_full_' + idx + ' .comments-list').append(data);
        	        $('#comment-form-' + idx + ' textarea').val('');
        	        $('#comment-form-' + idx + ' .warning').attr('style', 'display:none');
        	    },  
        	    error: function (XMLHttpRequest, textStatus, errorThrown) {  
        	        thisObject.replaceWith('Your comment could not be posted.');  
        	    }  
        	}); 
    	}
        return false;
    });  
} 

function toggle_visibility(id) {
  bindPostCommentHandler(id);
  var e = document.getElementById("comments_full_" + id);
  if (e.style.height == "100%") {	
  }
  else {
    $("#comments_full_" + id).animate({
          height: "100%",
        }, 100, function() {
          $("#comments_full_" + id).fadeIn('100');
          $("#show_comments" + id).removeAttr("onclick")	
        } 
    );
  }
}

function bindLikeHandler(idx) {
   $('#like_'+ idx).click(function() {
        $.getJSON("/like/", {xhr: "true", info: idx, laowai: '{{ laowai.id }}',},
          function(data) {
            $('#like_'+ idx).replaceWith(data);
        });	
   });
}

function nextPage(page) {
$.getJSON("/{{ city.slug }}/feed/", {xhr: "true", page: page},
  function(data) {
  	$(data).appendTo('#feed ul');
  	pageNum++; 
  });
}

var pageNum = {{ objects.next_page_number }}
$("#pagination").click(function () { 
	nextPage(pageNum); 
});

$("#loading").ajaxStart(function(){
   $('#pagination').hide();
   $(this).show();
 });

$("#loading").ajaxStop(function(){
   $(this).hide();
   $('#pagination').show();
 });

      
$(document).ready(function() { 
	{% for info in objects.object_list %} 
   	     bindLikeHandler({{ info.id }});
	{% endfor %}  
});  
</script>  
{% endblock %}


{% block extracss %}
<style type="text/css">
div#introduction {
  height: 300px;
  float: left;	
}

span.like {
 color: #2D7886;	
}

span.like:hover {
  color: #F67B7B;
  cursor: pointer;	
}

div#pagination {
    background-color: #F1F1F1;
    border: 2px dotted #e1e1e1;
    color: #2D7886;
    float: left;
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 40px;
    padding: 15px 0;
    text-align: center;
    width: 100%;
}

div#pagination:hover {
  cursor: pointer;
  background-color: #e1e1e1;
  color: #F67B7B;	
}
</style>
{% endblock %}

{% block content %}
	
<div id="top">
<h1>News from {{ city }}</h1>
{% if request.user.is_authenticated %}
{% else %}
	<p class="signup"><a href="{% url registration_register %}"><strong>Signup</strong></a> or <a href="/accounts/login/"><strong>login</strong></a> to add your news</p>
	{% endif %}
</div>

	
	<div id="feed">
		{% include "list/snippets/feed.html" %}
	</div>





{% endblock %}

{% block extra-content %}
	    {% if user.is_authenticated %}
			<div id="add-form">
			<img class="arrow" src="/images/arrow.png"/>
				{% include "list/snippets/add-form.html" %}
			</div>
		{% else %}
			<div id="add-form">
			<h4>You need to <a title="Signup to add posts to the mailing list and add comments" href="{% url registration_register %}">signup</a> to add your own news</h4>
			</div>
		{% endif %}
{% endblock %}
